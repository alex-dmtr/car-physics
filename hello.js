function drawText(t,e,i){var o=i.subtract(cameraPosition);t.fillStyle="black",t.font="15px Arial",t.textAlign="center",t.fillText(e,o.x,o.y)}function drawImageCentered(t,e,i,o){var n=e.subtract(cameraPosition);ctx.translate(n.x,n.y),ctx.rotate(i),ctx.drawImage(t,-o.width/2,-o.height/2,o.width,o.height),ctx.rotate(-i),ctx.translate(-n.x,-n.y)}function getLeftWheelPosition(){return car.position.add(new Vector2(-82,30).rotate(car.rotation))}function getRightWheelPosition(){return car.position.add(new Vector2(95,30).rotate(car.rotation))}function drawCar(){drawImageCentered(carImage,car.position,car.rotation,car.size),drawImageCentered(wheelImage,leftWheel.position,leftWheel.rotation,leftWheel.size),drawImageCentered(wheelImage,rightWheel.position,rightWheel.rotation,rightWheel.size)}function canvas_arrow(t,e,i,o,n){e-=cameraPosition.x,i-=cameraPosition.y,o-=cameraPosition.x,n-=cameraPosition.y;var r=Math.atan2(n-i,o-e);t.moveTo(e,i),t.lineTo(o,n),t.lineTo(o-10*Math.cos(r-Math.PI/6),n-10*Math.sin(r-Math.PI/6)),t.moveTo(o,n),t.lineTo(o-10*Math.cos(r+Math.PI/6),n-10*Math.sin(r+Math.PI/6))}function drawVector(t,e,i,o,n){t.beginPath(),t.fillStyle=o,t.strokeStyle=o,canvas_arrow(t,e.x,e.y,i.x,i.y),t.stroke(),t.closePath(),t.beginPath(),n&&(t.fillStyle=o,t.strokeStyle=o,t.arc(e.x-cameraPosition.x,e.y-cameraPosition.y,5,0,2*Math.PI,!0),t.fill(),t.closePath())}function drawPolygon(t){ctx.beginPath();for(var e=0;e<t.length-1;e++)ctx.moveTo(t[e].x-cameraPosition.x,t[e].y-cameraPosition.y),ctx.lineTo(t[e+1].x-cameraPosition.x,t[e+1].y-cameraPosition.y);ctx.stroke(),ctx.closePath()}function drawGraph(t,e,i,o,n=!1){maximum=new Vector2(o[0].x,o[0].y);for(var r=0;r<o.length;r++)o[r].x>maximum.x&&(maximum.x=o[r].x),o[r].y>maximum.y&&(maximum.y=o[r].y);ctx.beginPath(),ctx.fillStyle="black",ctx.strokeStyle="black",canvas_arrow(ctx,e.x,e.y,e.x,e.y-i.height),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.fillStyle="black",ctx.strokeStyle="black",canvas_arrow(ctx,e.x,e.y,e.x+i.width,e.y),ctx.stroke(),ctx.closePath(),ctx.beginPath();for(var r=0;r<o.length-1;r++){if(n)var a=new Vector2(e.x+o[r].x/maximum.x*i.width,e.y-i.height+o[r].y/maximum.y*i.height),c=new Vector2(e.x+o[r+1].x/maximum.x*i.width,e.y-i.height+o[r+1].y/maximum.y*i.height);else var a=new Vector2(e.x+o[r].x/maximum.x*i.width,e.y-o[r].y/maximum.y*i.height),c=new Vector2(e.x+o[r+1].x/maximum.x*i.width,e.y-o[r+1].y/maximum.y*i.height);ctx.moveTo(a.x,a.y),ctx.lineTo(c.x,c.y)}ctx.stroke(),ctx.closePath(),drawText(ctx,t,new Vector2(e.x+i.width/2,e.y+50))}function drawGraphs(){ctx.clearRect(0,0,width,height),ctx.strokeStyle="black",cameraPosition=new Vector2(0,0),drawGraph("y = y(t)",new Vector2(200,500),new Size(400,400),yHistory,!0),drawGraph("θ =  θ(t)",new Vector2(800,500),new Size(400,400),thetaHistory)}function draw(){var t=!0,e=!0;if(car.position.x>=width/2&&(t=!1),car.position.y<=height/2&&(e=!1),!t||!e){var o=new Vector2(0,0);t||(o.x+=car.position.x-width/2),e||(o.y+=car.position.y-height/2),cameraPosition=o}if(ctx.clearRect(0,0,width,height),ctx.strokeStyle="black",ctx.beginPath(),ctx.moveTo(0,groundHeight-cameraPosition.y),ctx.lineTo(width,groundHeight-cameraPosition.y),ctx.stroke(),ctx.closePath(),drawPolygon(inclinedPlane),drawCar(),isWater&&(ctx.beginPath(),ctx.fillStyle="rgba(153, 214, 255, 0.5)",ctx.fillRect(planeLength-cameraPosition.x,groundHeight-waterHeight-cameraPosition.y,5e3,waterHeight),ctx.closePath()),showForces)for(i=0;i<forces.length;i++){var n=Vector2.direction(forces[i].origin,forces[i].applicationPoint);drawVector(ctx,forces[i].origin,forces[i].applicationPoint,forces[i].color,forces[i].showOrigin),drawText(ctx,forces[i].name,forces[i].applicationPoint.add(n.rotate(Math.PI/2).multiply(20)),forces[i].color)}}function loop(t){forces=[],isWater=$("#isWater").get(0).checked;var e=car.position.add(Vector2.fromAngle(car.rotation).multiply(-(1-massSlider)*car.size.width/2)).add(Vector2.fromAngle(car.rotation).multiply(massSlider*car.size.width/2)),i=new Force("G","black",e,e.add(new Vector2(0,100)),!0);i.magnitude=9.81/5;var o=new Force("N1","blue",leftWheel.position.add(new Vector2(0,leftWheel.size.height).rotate(car.rotation)),leftWheel.position.add(new Vector2(0,.5*leftWheel.size.height).rotate(car.rotation))),n=new Force("N2","blue",rightWheel.position.add(new Vector2(0,rightWheel.size.height).rotate(car.rotation)),rightWheel.position.add(new Vector2(0,.5*rightWheel.size.height).rotate(car.rotation)));n.magnitude=.5*Vector2.project(i.getVector(),Vector2.fromAngle(car.rotation+Math.PI/2)).magnitude(),o.magnitude=.5*Vector2.project(i.getVector(),Vector2.fromAngle(car.rotation+Math.PI/2)).magnitude();var r=new Force("Fd","red",car.position.add(car.velocity.normalize().multiply(car.size.width)),car.position.add(car.velocity.normalize().multiply(car.size.width/2))),a=rho;isWater&&car.position.x>planeLength&&car.position.y>=groundHeight-waterHeight&&(a=100),r.magnitude=.5*frictionCoef*2.2*a*car.velocity.magnitude()*car.velocity.magnitude();var c=new Force("Ft","green",rightWheel.position.add(new Vector2(0,rightWheel.size.height/2)),rightWheel.position.add(new Vector2(0,rightWheel.size.height/2)).add(Vector2.fromAngle(car.rotation).multiply(rightWheel.size.width)));c.magnitude=4,forces.push(i);rightWheel.position.y,rightWheel.size.height,groundHeight,rightWheel.position.x,Math.tan(inclinedPlaneRotation),leftWheel.position.y,leftWheel.size.height,groundHeight,leftWheel.position.x,Math.tan(inclinedPlaneRotation);rightWheelOnPlane=rightWheel.position.x<planeLength,leftWheelOnPlane=leftWheel.position.x<planeLength,rightWheelOnPlane&&(forces.push(n),(pressedAcceleration||$("#autoAcc").get(0).checked)&&forces.push(c)),leftWheelOnPlane&&forces.push(o),0!=car.velocity.magnitude()&&forces.push(r);for(var h=new Vector2(0,0),l=0,s=0;s<forces.length;s++)h=h.add(forces[s].getVector()),rightWheelOnPlane&&"G"==forces[s].name||rightWheelOnPlane&&"N1"==forces[s].name||"N2"==forces[s].name||"Ft"==forces[s].name||(l+=Vector2.crossProduct(forces[s].applicationPoint.subtract(car.position),forces[s].getVector()));l+=.5*a*frictionCoef*-car.angularVelocity*car.angularVelocity,car.angularAcceleration=l/5,car.angularVelocity+=car.angularAcceleration*t;var g=car.angularVelocity*t;car.rotation+=g*(Math.PI/180);var d=car.acceleration,u=car.velocity.multiply(t).add(d.multiply(.5*t*t)),m=h,w=d.add(m).multiply(.5);car.velocity=car.velocity.add(w.multiply(t)),car.position=car.position.add(u.multiply(100)),leftWheel.position=getLeftWheelPosition(),rightWheel.position=getRightWheelPosition(),leftWheelOnPlane&&(leftWheel.rotation+=u.magnitude()),rightWheelOnPlane&&(rightWheel.rotation+=u.magnitude()),draw()}function stepSimulation(t){start||(start=t),loop((t-start)/1e3),start=t,rightWheelOnPlane||(startedRecording||(recordingStartTime=t,startedRecording=!0),yHistory.push(new Vector2((t-recordingStartTime)/1e3,car.position.y)),thetaHistory.push(new Vector2((t-recordingStartTime)/1e3,car.rotation))),car.position.x>planeLength&&(leftWheel.position.y+leftWheel.size.height/2>=groundHeight||rightWheel.position.y+rightWheel.size.height/2>=groundHeight)?$("#canvas").fadeOut(2e3,function(){drawGraphs(),$("#canvas").fadeIn(1500)}):window.requestAnimationFrame(stepSimulation)}function play(){startedRecording=!1,rightWheelOnPlane=!0,yHistory=[],thetaHistory=[],carImage=$("#car").get(0),wheelImage=$("#wheel").get(0),rho=$("#rho").val(),frictionCoef=$("#frictionCoef").val(),massSlider=$("#massSlider").val(),isWater=$("#isWater").get(0).checked,width=ctx.canvas.width=window.innerWidth,groundHeight=height-150,car=new Rigidbody(new Vector2(0,groundHeight-39-20),0,new Size(300,78)),car.mass=$("#carMass").val(),leftWheel=new Rigidbody(new Vector2(-82,groundHeight-27.5),0,new Size(55,55)),rightWheel=new Rigidbody(new Vector2(95,groundHeight-27.5),0,new Size(55,55)),leftWheel.position=getLeftWheelPosition(),rightWheel.position=getRightWheelPosition(),cameraPosition=new Vector2(0,0),start=!1,passedPlane=!1,planeLength=1e3,inclinedPlane=[],inclinedPlaneRotation=$("#inclinedPlaneRotation").val()*(Math.PI/180),inclinedPlane.push(new Vector2(0,groundHeight)),inclinedPlane.push(new Vector2(planeLength,groundHeight-planeLength*Math.tan(inclinedPlaneRotation))),inclinedPlane.push(new Vector2(planeLength,groundHeight)),inclinedPlane.push(new Vector2(0,groundHeight)),waterHeight=planeLength*Math.tan(inclinedPlaneRotation)*.5,car.rotation=-inclinedPlaneRotation,window.requestAnimationFrame(stepSimulation)}class Vector2{constructor(t,e){this.x=t,this.y=e}add(t){return new Vector2(this.x+t.x,this.y+t.y)}subtract(t){return new Vector2(this.x-t.x,this.y-t.y)}multiply(t){return new Vector2(this.x*t,this.y*t)}normalize(){return this.multiply(1/this.magnitude())}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}toDirection(){return new Vector2(this.x/this.magnitude(),this.y/this.magnitude())}rotate(t){var e=Math.atan2(this.y,this.x);return e+=t,Vector2.fromAngle(e).multiply(this.magnitude())}}Vector2.direction=function(t,e){return e.subtract(t).toDirection()},Vector2.fromAngle=function(t){return new Vector2(Math.cos(t),Math.sin(t)).normalize()},Vector2.distance=function(t,e){return e.subtract(t).magnitude()},Vector2.crossProduct=function(t,e){return t.x*e.y-t.y*e.x},Vector2.dotProduct=function(t,e){return t.x*e.x+t.y*e.y},Vector2.project=function(t,e){return new Vector2(t.x*e.x,t.y*e.y)};class Size{constructor(t,e){this.width=t,this.height=e}}class Rigidbody{constructor(t,e,i){this.position=t,this.rotation=e,this.size=i,this.mass=1,this.velocity=new Vector2(0,0),this.acceleration=new Vector2(0,0),this.angularVelocity=0,this.angularAcceleration=0}}class Force{constructor(t,e,i,o,n=!1){this.name=t,this.origin=i,this.applicationPoint=o,this.color=e,this.showOrigin=n,this.magnitude=1}getVector(){return Vector2.direction(this.origin,this.applicationPoint).multiply(this.magnitude)}setVector(t){this.applicationPoint=this.origin.add(t.normalize().multiply(this.magnitude))}}$(document).ready(function(){height=800,width=1e3;var t=$("#canvas").get(0);ctx=t.getContext("2d"),animationInterval=0,showForces=$("#showForces").get(0).checked,$("#showForces").change(function(){showForces=this.checked}),pressedAcceleration=!1,$(document).keydown(function(t){var e=String.fromCharCode(t.which);"a"!=e&&"A"!=e||(pressedAcceleration=!0)}),$(document).keyup(function(t){pressedAcceleration=!1}),windowWidth=$(window).width(),windowHeight=$(window).height(),$(window).resize(function(){windowWidth=$(window).width(),windowHeight=$(window).height()})});
