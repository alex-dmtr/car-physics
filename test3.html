<html>

<head>
    <title>Mecanica unei masini in miscare</title>
    <!-- Latest compiled and minified CSS -->
<!--<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">-->

<!-- jQuery library -->
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>-->

<!-- Latest compiled JavaScript -->
<!--<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>-->

<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/bootstrap-theme.css">
<script src="jquery-1.12.3.min.js"></script>
<script src="js/bootstrap.js"></script>

<script type="text/javascript">

        class Vector2
        {
            constructor(x, y)
            {
                this.x = x;
                this.y = y;

            }

            add(other)
            {
                return new Vector2(this.x + other.x, this.y + other.y);
            }

            subtract(other)
            {
                return new Vector2(this.x - other.x, this.y - other.y);
            }

            multiply(by)
            {
                return new Vector2(this.x * by, this.y * by);
            }

            normalize()
            {
                return this.multiply(1 / (this.magnitude()));
            }

            magnitude()
            {
                return Math.sqrt(this.x * this.x + this.y * this.y);
            }

            toDirection()
            {
                return new Vector2(this.x / this.magnitude(), this.y / this.magnitude());
            }

            rotate(angle)
            {
                var currentAngle = Math.atan2(this.y, this.x);
                currentAngle += angle;
                return Vector2.fromAngle(currentAngle).multiply(this.magnitude());
            }

        }

        Vector2.direction = function(a, b)
        {
            return b.subtract(a).toDirection();
        }

        Vector2.fromAngle = function(angle)
        {
            return new Vector2(Math.cos(angle), Math.sin(angle)).normalize();
        }

        Vector2.distance = function(a, b)
        {
            return b.subtract(a).magnitude();
        }

        class Size
        {
            constructor(width, height)
            {
                this.width = width;
                this.height = height;
            }
        }

        class Rigidbody
        {
            constructor(position, rotation, size)
            {
                this.position = position;
                this.rotation = rotation;
                this.size = size;
                this.mass = 1;

                this.velocity = new Vector2(0, 0);
                this.acceleration = new Vector2(0, 0);

                this.angularVelocity = 0;
                this.angularAcceleration = 0;
            }
        }

        class Force
        {
            constructor(name, color, origin, applicationPoint, showOrigin = false)
            {
                this.name = name;
                this.origin = origin;
                this.applicationPoint = applicationPoint;
                this.color = color;
                this.showOrigin = showOrigin;

            }
        }
    

    
    function drawText(ctx, text, absolutePosition)
    {
        var position = absolutePosition.subtract(cameraPosition);

        ctx.fillStyle = "black";
        ctx.font = "15px Arial";
        ctx.textAlign = "center";   
        ctx.fillText(text,position.x, position.y);
    }
    function drawImageCentered(image, absolutePosition, rotation, size)
    {
        var position = absolutePosition.subtract(cameraPosition);

        ctx.translate(position.x, position.y);
        ctx.rotate(rotation);

        ctx.drawImage(image, - size.width / 2, - size.height / 2, size.width, size.height);

        ctx.rotate(-rotation);

        ctx.translate(-position.x, -position.y);
    }

    /*function getLeftWheelPosition()
    {

        console.log(":(");
        return car.position.add(new Vector2(-82, 30).rotate(car.rotation));
       // return new Vector2(car.position.x - 82, car.position.y + 30);
    }*/

    /*function getRightWheelPosition()
    {
        console.log(":(");
        return car.position.add(new Vector2(95, 30).rotate(car.rotation));
        //return new Vector2(car.position.x + 95, car.position.y + 30);

    }*/
    function drawCar()
    {
         drawImageCentered(carImage, car.position, car.rotation, car.size);

        //ctx.drawImage(wheelImage, leftWheelPosition.x, leftWheelPosition.y, 55, 55);
        //ctx.drawImage(wheelImage, rightWheelPosition.x, leftWheelPosition.y, 55, 55);
        drawImageCentered(wheelImage, leftWheel.position, leftWheel.rotation, leftWheel.size);
        drawImageCentered(wheelImage, rightWheel.position, rightWheel.rotation, rightWheel.size);
    }



    function canvas_arrow(context, fromx, fromy, tox, toy)
    {
        var headlen = 10;   // length of head in pixels
        fromx -= cameraPosition.x;
        fromy -= cameraPosition.y;

        tox -= cameraPosition.x;
        toy -= cameraPosition.y;

        var angle = Math.atan2(toy-fromy,tox-fromx);
        context.moveTo(fromx, fromy);
        context.lineTo(tox, toy);
        context.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));
        context.moveTo(tox, toy);
        context.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));
    }

    function drawVector(ctx, origin, applicationPoint, color, showOrigin)
    {
        var magnitude = 100;

        //var origin = new Vector2(applicationPoint.x + magnitude * Math.cos(angle+Math.PI), applicationPoint.y + magnitude * Math.sin(angle+Math.PI));

        ctx.beginPath();

        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        canvas_arrow(ctx, origin.x, origin.y, applicationPoint.x, applicationPoint.y);
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();

        if (showOrigin)
        {
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            ctx.arc(origin.x-cameraPosition.x, origin.y-cameraPosition.y, 5, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.closePath();
            }
    }

    function drawPolygon(points)
    {
        ctx.beginPath();
        for (var i = 0; i < points.length - 1; i++)
        {
            ctx.moveTo(points[i].x-cameraPosition.x, points[i].y-cameraPosition.y);
            ctx.lineTo(points[i+1].x-cameraPosition.x, points[i+1].y-cameraPosition.y);
        }
        ctx.stroke();
        ctx.closePath();
    }

    function draw()
    {
        if (car.position.x + car.size.width * 1.5 >= width - cameraPosition.x)
            cameraPosition.x += car.position.x + car.size.width * 1.5 - width - cameraPosition.x;

        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = "black";

        // ground
        ctx.beginPath();
        ctx.moveTo(0, groundHeight);
        ctx.lineTo(width, groundHeight);

        ctx.stroke();
        ctx.closePath();

        // inclined plane
    drawPolygon(inclinedPlane);
        /*ctx.moveTo(600, groundHeight);
        ctx.lineTo(800, groundHeight-200);
        ctx.moveTo(800, groundHeight-200);
        ctx.lineTo(800, groundHeight);
        ctx.moveTo(800, groundHeight);
        ctx.lineTo(600, groundHeight);*/
        ctx.stroke();
        ctx.closePath();

        // car
          drawCar();

        // forces
        if (showForces)
        {
            for (i = 0; i < forces.length; i++)
            {
                var direction = Vector2.direction(forces[i].origin, forces[i].applicationPoint);

                drawVector(ctx, forces[i].origin, forces[i].applicationPoint, forces[i].color, forces[i].showOrigin);
                drawText(ctx, forces[i].name, forces[i].applicationPoint.add(direction.rotate(Math.PI/2).multiply(20)), forces[i].color);
            }
        }
    }


       function loop(dt)
            { 
                forces = [];


                // both wheels on ground
                var gravity = new Force("G", "black", car.position, car.position.add(new Vector2(0, 100)), true);
                var normalLeft = new Force("N1", "blue", new Vector2(leftWheel.position.x, groundHeight+50), new Vector2(leftWheel.position.x, groundHeight));
                var normalRight = new Force("N2", "blue", new Vector2(rightWheel.position.x, groundHeight+50), new Vector2(rightWheel.position.x, groundHeight));
                

                var drag = new Force("Fd", "red", car.position.add(Vector2.fromAngle(car.rotation).multiply(car.size.width)), car.position.add(Vector2.fromAngle(car.rotation).multiply(car.size.width/2)))
                var traction = new Force("Ft", "green", rightWheel.position.add(new Vector2(0, rightWheel.size.height/2)), rightWheel.position.add(new Vector2(0, rightWheel.size.height/2)).add(Vector2.fromAngle(car.rotation).multiply(rightWheel.size.width)));


                if (rightWheel.position.x >= inclinedPlane[0].x)
                {
                    rightWheel.position.y = (wrightWheel.position.x - inclinedPlane[0].x) * Math.tan(-inclinedPlane);
                }
             /*   if (car.position.x >= inclinedPlane[0].x && !passedPlane)
                {
                    car.rotation = -inclinedPlaneRotation;

                    car.velocity = new Vector2(0, 0);
                    passedPlane = true;
                }
*/

                //gravity.magnitude = 9.81 * car.mass; 

                forces.push(gravity);
                forces.push(normalLeft);
                forces.push(normalRight);
                if (pressedAcceleration)
                {
                    forces.push(traction);
                }

                if (car.velocity.x > 0)
                {
                    forces.push(drag);
                }
                    
                
                var finalForce;


                // Velocity verlet integration
                var last_acceleration = car.acceleration;
                var dr = car.velocity.multiply(dt).add(last_acceleration.multiply(0.5 * dt * dt));

             
                var new_acceleration = new Vector2(0, 0);
                if (pressedAcceleration)
                    new_acceleration = Vector2.fromAngle(car.rotation);

                    if (car.velocity.x > 0)
                        new_acceleration.add(new Vector2(- 0.5 * 0.30 * 2.2 * rho * car.velocity.x * car.velocity.x, 0).rotate(car.rotation));
                    else if (!pressedAcceleration)
                        new_acceleration = new Vector2(0, 0);

                var avg_acceleration = last_acceleration.add(new_acceleration).multiply(1/2);

                car.velocity = car.velocity.add(avg_acceleration.multiply(dt));
                
                //  car.position = car.position.add(dr.multiply(100)); 
                leftWheel.position = leftWheel.position.add(dr.multiply(100));
                rightWheel.position = rightWheel.position.add(dr.multiply(100));
  // leftWheel.position = getLeftWheelPosition();
               // rightWheel.position = getRightWheelPosition();
                //
                car.position = leftWheel.position.multiply(95/(82+95)).add(rightWheel.position.multiply(82/(82+95))).add(new Vector2(0, -30));//leftWheel.position.add(rightWheel.position).multiply(1/2).add(new Vector2(0, -30));

                car.rotation = Math.atan2(rightWheel.position.y-leftWheel.position.y, rightWheel.position.x - leftWheel.position.x);

                leftWheel.rotation += dr.magnitude();
                rightWheel.rotation += dr.magnitude();
   

                

                draw();



        }


    function stepSimulation(timestamp) {
      if (!start) start = timestamp;
      var progress = timestamp - start;
      //console.log(progress / 1000);
        loop(progress / 1000);    
        start = timestamp;
    window.requestAnimationFrame(stepSimulation);

      }
    
    function play()
    {


            carImage = $("#car").get(0);
            wheelImage = $("#wheel").get(0);

            rho = $("#rho").val();

           groundHeight = height - 150;
            car = new Rigidbody(new Vector2(200, groundHeight - 78 / 2 - 20), 0, new Size(300, 78));
            car.mass = $("#carMass").val();



            leftWheel = new Rigidbody(new Vector2(-82, groundHeight - 55 / 2), 0, new Size(55, 55));
            rightWheel = new Rigidbody(new Vector2(95, groundHeight - 55 / 2), 0, new Size(55, 55));
            
            //leftWheel.position = getLeftWheelPosition();
            //rightWheel.position = getRightWheelPosition();


            cameraPosition = new Vector2(0, 0);
            start = false;

            passedPlane = false;

            inclinedPlane = [];
            inclinedPlaneRotation = Math.PI/6;
            inclinedPlane.push(new Vector2(1000, groundHeight));
            inclinedPlane.push(new Vector2(1500, groundHeight-500*Math.tan(inclinedPlaneRotation)));
            inclinedPlane.push(new Vector2(1500, groundHeight));
            inclinedPlane.push(new Vector2(1000, groundHeight));

        
                window.requestAnimationFrame(stepSimulation);
       //     clearInterval(animationInterval);
     //       animationInterval = setInterval(loop, dt * 1000);
    }



        $(document).ready(function()
        {
            height = 700;
            width =  1000;
            //dt = 0.02;


            var canvas = $("#canvas").get(0);
            ctx = canvas.getContext('2d');
            
            animationInterval = 0;

            showForces = $("#showForces").get(0).checked;
            $("#showForces").change(function() 
            {
                showForces = this.checked;
            })

            pressedAcceleration = false;
            $(document).keydown(function(event){
                var x = String.fromCharCode(event.which); 
                if (x == 'a' || x == 'A')
                {
                    pressedAcceleration = true;
                }
            });

            $(document).keyup(function(event) {
                pressedAcceleration = false;
            });

        /* A real project should use requestAnimationFrame, and you should time the frame rate and pass a variable "dt" to your physics function. This is just a simple brute force method of getting it done. */
    //setInterval(loop, dt * 1000);

    })
       
    

    </script>
    
</head>

<body>
    <div class="container">
        <div class="form-group">
            <label for="rho">Densitatea mediului:</label>
            <input type="number" step="0.01" id="rho" name="rho" value="1.2" class="form-control" />
            <label for="carMass">Masa masinii [kg]:</label>
            <input type="number" step="1" id="carMass" name="carMass" value="1500" class="form-control"/>
            <label for="frictionCoef">Coeficientul de frecare:</label>
            <input type="number" step="0.01" id="frictionCoef" name="frictionCoef" value="0.30" class="form-control"/>
    
            <label for="showForces">Vizualizare forte</label>
            <input type="checkbox" name="showForces" id="showForces" checked/>

             <br/>
              <button class="btn btn-primary" onclick="play()">Play</button>

        </div>

        
        <img id="car" src="http://i.imgur.com/Xb3oETf.png" style="width:300; height:78" hidden="true"/>
        <img id="wheel" src="http://i.imgur.com/DXIT9yw.png" style="width:55; height:55" hidden="true"/>
    </div>
    <div class="container">
    <canvas class="centered" id="canvas" height="700" width="1000" ></canvas>
    
    </div>
</body>

</html>